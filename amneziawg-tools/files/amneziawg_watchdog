#!/bin/sh
# SPDX-License-Identifier: GPL-2.0
#
# Copyright (C) 2018 Aleksandr V. Piskunov <aleksandr.v.piskunov@gmail.com>.
# Copyright (C) 2015-2018 Jason A. Donenfeld <Jason@zx2c4.com>. All Rights Reserved.
#
# This watchdog script tries to re-resolve hostnames for inactive AmneziaWG peers.
# Use it for peers with a frequently changing dynamic IP.
# persistent_keepalive must be set, recommended value is 25 seconds.
#
# Run this script from cron every minute:
# echo '* * * * * /usr/bin/amneziawg_watchdog' >> /etc/crontabs/root

# shellcheck disable=SC1091,SC3043

# Strict mode for better error handling
set -euo pipefail 2>/dev/null || set -eu

AWG=/usr/bin/awg
AWG_LOG_TAG="amneziawg_monitor"
IDLE_THRESHOLD=150  # seconds before re-resolving

# Logging function
log_msg() {
	local level="$1"
	shift
	logger -t "$AWG_LOG_TAG" "$level: $*"
}

log_info() {
	log_msg "info" "$*"
}

log_warn() {
	log_msg "warn" "$*"
}

# Check if peer is an IP address (skip if so)
_is_ip_address() {
	local host="$1"
	# IPv4 check
	case "$host" in
		[0-9].[0-9].[0-9].[0-9]|[0-9].[0-9].[0-9].[0-9]:*) return 0 ;;
	esac
	# IPv6 check (contains colons but not a hostname)
	case "$host" in
		*:*) return 0 ;;
	esac
	return 1
}

check_peer_activity() {
	local cfg="$1"
	local iface="$2"
	local disabled public_key endpoint_host endpoint_port
	local persistent_keepalive last_handshake idle_seconds

	config_get_bool disabled "${cfg}" "disabled" 0
	config_get public_key    "${cfg}" "public_key"
	config_get endpoint_host "${cfg}" "endpoint_host"
	config_get endpoint_port "${cfg}" "endpoint_port"

	# Skip disabled peers
	[ "${disabled}" -eq 1 ] && return 0

	# Skip if no endpoint
	[ -z "${endpoint_host}" ] && return 0

	# Skip if endpoint is an IP address
	_is_ip_address "${endpoint_host}" && return 0

	# Check if keepalive is enabled
	persistent_keepalive=$("${AWG}" show "${iface}" persistent-keepalive 2>/dev/null | \
		grep "${public_key}" | awk '{print $2}')
	if [ -z "${persistent_keepalive}" ] || [ "${persistent_keepalive}" = "off" ]; then
		return 0
	fi

	# Check last handshake time
	last_handshake=$("${AWG}" show "${iface}" latest-handshakes 2>/dev/null | \
		grep "${public_key}" | awk '{print $2}')
	[ -z "${last_handshake}" ] && return 0

	idle_seconds=$(($(date +%s) - last_handshake))
	[ "${idle_seconds}" -lt "${IDLE_THRESHOLD}" ] && return 0

	# Re-resolve endpoint
	log_info "${iface} endpoint ${endpoint_host}:${endpoint_port} is not responding for ${idle_seconds}s, re-resolving..."
	"${AWG}" set "${iface}" peer "${public_key}" endpoint "${endpoint_host}:${endpoint_port}" 2>/dev/null || \
		log_warn "failed to re-resolve ${endpoint_host}:${endpoint_port}"
}

# Get all active AmneziaWG interfaces
get_awg_interfaces() {
	ubus -S call network.interface dump 2>/dev/null | \
		jsonfilter -e '@.interface[@.up=true]' | \
		jsonfilter -a -e '@[@.proto="amneziawg"].interface' 2>/dev/null || true
}

# Main execution
. /lib/functions.sh

config_load network

awg_ifaces=$(get_awg_interfaces)
for iface in $awg_ifaces; do
	config_foreach check_peer_activity "amneziawg_${iface}" "${iface}"
done
