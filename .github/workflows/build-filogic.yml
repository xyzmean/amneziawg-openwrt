name: Build AmneziaWG for Filogic

on:
  workflow_dispatch:
    inputs:
      openwrt_version:
        description: "OpenWrt version"
        type: choice
        required: true
        default: "SNAPSHOT"
        options:
          - SNAPSHOT
          - 24.10.2
          - 24.10.1
          - 24.10.0
          - 23.05.5
          - 23.05.4
      amneziawg_version:
        description: "AmneziaWG version (branch or tag)"
        type: string
        required: true
        default: "master"
      implementation:
        description: "Implementation to compile"
        type: choice
        required: true
        default: "both"
        options:
          - both
          - kmod_only
          - go_only

env:
  OPENWRT_TARGET: filogic
  OPENWRT_SUBTARGET: generic
  OPENWRT_ARCH: aarch64_cortex-a53

jobs:
  build-filogic:
    name: "Build AmneziaWG for Filogic: ${{ inputs.openwrt_version }}"
    runs-on: ubuntu-22.04
    defaults:
      run:
        shell: bash

    steps:
    - name: Checkout YAAWG repository
      uses: actions/checkout@v5
      with:
        path: amneziawg
        ref: ${{ inputs.amneziawg_version }}
        fetch-depth: 0

    - name: Checkout OpenWRT Packages repository
      uses: actions/checkout@v5
      if: ${{ inputs.implementation != 'kmod_only' }}
      with:
        path: packages
        repository: openwrt/packages
        fetch-depth: 0

    - name: Install build dependencies
      run: |
        set -e -x
        sudo apt-get update
        sudo apt-get install -y \
          python3-pyelftools \
          python3-dev \
          python3-setuptools \
          swig \
          build-essential \
          ccache \
          ecj \
          jar \
          java-common \
          python3 \
          python3-mako \
          python3-pyelftools \
          python3-setuptools \
          python3-six \
          ruby \
          rsync \
          subversion \
          unzip \
          wget \
          zlib1g-dev

    - name: Setup ccache
      uses: actions/cache@v4
      with:
        path: .ccache
        key: ccache-filogic-${{ inputs.openwrt_version }}-${{ github.run_id }}
        restore-keys: |
          ccache-filogic-${{ inputs.openwrt_version }}-

    - name: Download and prepare OpenWrt SDK for Filogic
      env:
        compile_go: ${{ inputs.implementation != 'kmod_only' }}
      run: |
        set -e -x

        # Determine SDK URL based on OpenWrt version
        if [ "${{ inputs.openwrt_version }}" = "SNAPSHOT" ]; then
          base_url="https://downloads.openwrt.org/snapshots/targets/mediatek/filogic/"
        else
          base_url="https://downloads.openwrt.org/releases/${{ inputs.openwrt_version }}/targets/mediatek/filogic/"
        fi

        # Find SDK file
        sdk_url=$(curl -s "${base_url}" | grep -oP 'href="openwrt-sdk[^"]+\.tar\.(zst|xz)"' | sed -e 's/href="//' -e 's/"$//' | head -n1)

        if [[ -z "$sdk_url" ]]; then
          echo "âŒ SDK file not found for version ${{ inputs.openwrt_version }}"
          echo "Available versions at: ${base_url}"
          exit 1
        fi

        echo "ðŸ“¦ Downloading SDK: $sdk_url"
        curl -fsLO "$base_url$sdk_url"
        file_name=$(basename "$sdk_url")

        echo "ðŸ“‚ Extracting SDK..."
        tar -xf "$file_name"
        rm -f *.tar.zst *.tar.xz
        mv openwrt-sdk* openwrt

        # Configure feeds
        echo "src-cpy awgopenwrt ../amneziawg" >> openwrt/feeds.conf.default

        # Update and install feeds
        cd openwrt
        echo "ðŸ”„ Updating feeds..."
        ./scripts/feeds update -a

        # Download config.buildinfo for the target
        curl -fsL "$base_url/config.buildinfo" > .config

        # Enable required packages
        echo "CONFIG_PACKAGE_kmod-crypto-lib-chacha20=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-lib-chacha20poly1305=y" >> .config
        echo "CONFIG_PACKAGE_kmod-crypto-chacha20poly1305=y" >> .config

        # Enable AmneziaWG packages
        echo "CONFIG_PACKAGE_kmod-amneziawg=y" >> .config
        echo "CONFIG_PACKAGE_amneziawg-tools=y" >> .config
        echo "CONFIG_PACKAGE_luci-proto-amneziawg=y" >> .config

        # Enable Go implementation if requested
        if [ "${{ env.compile_go }}" = "true" ] || [ "${{ inputs.implementation }}" = "both" ] || [ "${{ inputs.implementation }}" = "go_only" ]; then
          echo "CONFIG_PACKAGE_amneziawg-go=y" >> .config
          # Replace golang with newer version
          rm -rf feeds/packages/lang/golang
          cp -r ../packages/lang/golang feeds/packages/lang
        fi

        # Install feeds
        echo "ðŸ“¦ Installing feeds..."
        ./scripts/feeds install -a

        # Prepare for compilation
        make defconfig

    - name: Compile AmneziaWG packages
      env:
        compile_kmod: ${{ inputs.implementation != 'go_only' }}
        compile_go: ${{ inputs.implementation != 'kmod_only' }}
      run: |
        set -e -x
        cd openwrt

        # Compile based on implementation selection
        if [ "${{ env.compile_kmod }}" = "true" ]; then
          echo "ðŸ”¨ Compiling kmod-amneziawg..."
          make package/kmod-amneziawg/{clean,download,prepare,compile} -j $(nproc)
        fi

        if [ "${{ env.compile_go }}" = "true" ]; then
          echo "ðŸ”¨ Compiling amneziawg-go..."
          make package/amneziawg-go/{clean,download,prepare,compile} -j $(nproc)
        fi

        echo "ðŸ”¨ Compiling luci-proto-amneziawg..."
        make package/luci-proto-amneziawg/{clean,download,prepare,compile} -j $(nproc)

        echo "ðŸ”¨ Compiling amneziawg-tools..."
        make package/amneziawg-tools/{clean,download,prepare,compile} -j $(nproc)

    - name: Prepare release artifacts
      run: |
        set -e -x
        mkdir -p awgrelease

        # Copy kernel module if compiled
        if [ "${{ inputs.implementation }}" != "go_only" ]; then
          find "openwrt/bin/targets/mediatek/filogic/packages" -maxdepth 1 -type f -name 'kmod-amneziawg*' -exec cp {} awgrelease \; 2>/dev/null || true
        fi

        # Copy all IPK/APK files
        find "openwrt/bin/packages/aarch64_cortex-a53/awgopenwrt" -maxdepth 1 -type f \( -name '*.ipk' -o -name '*.apk' \) -exec cp {} awgrelease \; 2>/dev/null || true

        # Create package list
        echo "ðŸ“‹ Package list:" > awgrelease/packages.txt
        ls -lh awgrelease/*.ipk awgrelease/*.apk 2>/dev/null >> awgrelease/packages.txt || true

        echo "ðŸ“¦ Release contents:"
        ls -lh awgrelease/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: amneziawg-filogic-${{ inputs.openwrt_version }}-${{ inputs.implementation }}
        path: awgrelease/*
        retention-days: 30

    - name: Create release summary
      if: always()
      run: |
        echo "## ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Target:** mediatek/filogic (aarch64_cortex-a53)" >> $GITHUB_STEP_SUMMARY
        echo "**OpenWrt Version:** ${{ inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Implementation:** ${{ inputs.implementation }}" >> $GITHUB_STEP_SUMMARY
        echo "**AmneziaWG Version:** ${{ inputs.amneziawg_version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Built Packages" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat awgrelease/packages.txt 2>/dev/null || echo "No packages found"
        echo '```' >> $GITHUB_STEP_SUMMARY
